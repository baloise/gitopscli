os: linux
dist: xenial
language: shell

env:
  global:
    - DOCKER_IMAGE: baloise/gitopscli
    - DOCKER_BUILDKIT: '1' # use BuildKit backend (https://docs.docker.com/engine/reference/builder/#buildkit)
    - BUILDKIT_PROGRESS: plain
    # DOCKER_USERNAME
    - secure: "Ecq9r+yXVc9gVdn1e4sDS/yegMKOyN3F6f4jxNSNl1pEkBZayVOvl6seh58sK+QzaIOLlrMYNlOzmWIKaekRuskYLJNYMUh67RJB24knOMSbA0hD3WPO8GbFY1Y/Xe1Gk5zKlLqFKe9OoCbM0ItGIXL2DrFPWl94F1YoZim2h7q6lFEo9NHvYSjreGMcqJujQKoN5/UkO76C3TEKNFXbyxev18nHwXQvqC2axbZONYEQuzYC7dDDAHRMxQ25t2qcWh19f/ssl0qR7VYheBY72Pypvl131+qIxaMl+r/7UeKHnhrM2/ineyo8VPfxhHwar31ldu0YyC0KtSYEMERASsKmJNyaP9d3mo6Vciws/8fGaU0FqlwfRPOhaa/ixMS43qJ4NS9vSogteQJVIIC4B9mHmFvzShDK5aDML+KJ0ehQnayS/30AywS80iSkSWdbkKPAdr+djVhUbey+LAWPVdmJOnIiBET4eSFqJ37dXmcKrhUcfrthL2SftkTGZ4Fm4gHPNYWXIej9N6kTwHlYzRkuJN3PNTLsqp9YE6dUYIUZEu0qkyX2IBljdOxLK5UTKzdkD+j8kLFEP2kN1ELbhP4qEBJj17swycTP9wR4RB+FfjsdeTXonaEOGq8z2CctnczJe87TJ1/GuRj5l/VXiK2ph25El/Axhg5Kv3lHxJw="
    # DOCKER_PASSWORD
    - secure: "SDKm8YVvt1Ca5x7adAXdjJmqqyZN+LcVloqQ7K4JgFBBBgxOSH5PzmiZ9egCuti9/w0Do6xM8NTZmlvLBA73AYovJkpSwi9VMdtbHvVptZKJ8ipKDq3LteNf/8/lVgRBVDB6s1/SfG/5zsgusJF6HonyoqH4Iw0W2mG9tNyvftat/7bkEr72BKF05Onqj7c88/scMJwSl0nek4aOLpgnAf4aPOYJx4JS3hBAphqhR8W8kMJrLGGdlgRK2Pv9ybWhObu7mmZx8+Gh6H1E4vOVi8w2HS6WRDy+qa0c3hpIR22FlkZX6ewqLtGg8ru/Xbz3jTry1Ik30NkZ4wAwm3ad/FQtdPBDto9q0niz4KFMWbuUMahDSjn58pEr1rEWilbrodkwXuWCvBRaRr98zbHyd2qahhiGe93Rhp88NE6xWqOtgdNetcU2VeVmUlJoAUEO5GlsIf2+DDjIxCpkRBY6Da7bcfVa/miQTLOeXphJSPD6340jCjh0k4lmLdsqoy1030Wl32+jGy6mBYPTqL2w8K5oCEk/GaKZWLQj6yz374fz76q+aaPnrYdru/+rcaONJWsLaF8l210ZfCS3PznjxpJBMiAOqkJBnNK6TpmQUnVUicJRd3yJdwi7eX8sFRBbgu1ubjQLWs99aiuPIkPbG+NYYbMyRXmq4cIfsSCWoO8="
    # GITHUB_TOKEN
    - secure: "hL47rYiUAyKhjen/5LQ6G2CifT3FsLhWaL1WYGtz7wjD1yd8W4vEN7IaKK6SncZVMkoujPKqNAj7mGSm9HtcSp51kTpXTUGc5baIqMEqOFqP/1gRLGpKlq18trIXplE04l2gzHCM3gfMboV23v9u4aC9wFayNKkKt4J5R4cz35SgaktodIE9xha+dS5vuWp9HFNCa+M+mtFoA4SSD7iyLafMd5ycDU93/6zQRaScW7nJRkfWdtvm6lhQQnJZPkVxmtb1cv7VNROigjYTAtDP53svT+4qeO6siW3ROntqjSwRRVQHbZ6SJloB6fQEbHAagDnaUlHETVXh+FVC9xBN+x0ND8/AcSKi0ZSiPrZcmhfjwTVKY6IGYw68WN+QE0XOSGFwBEdvBm+PtFe6JbsptqH+8vcqCLKzQRAqdkW2G984Szuf1mIFT23wfEJcMruVrXdrsp09u0pVRkxpZ7ZuFrmp0nCMJVAMGwIcMIRSoAlulJ4N5pBuHD0LUPJ+Lks9zD2yu4KOlfcbBmznBQDR2ISdRw4dNDMFJi512iLp0akbeVOul0KLuXWJREszboP6fmoVQSWvMimhyYbsitT8KufDhmsVdEoCzhRtO2yWXNM4Uvnrc7oy4ZDDg/DiK75z5Sg6s+lUQAX+AN2sV9h7Bd0rTl1+Di+bYw78z/TR278="

jobs:
  include:
    - stage: test
      language: shell
      services: docker
      script: docker build --target=test .
    - stage: doc
      language: shell
      services: docker
      script: docker build --target=docs-site --output . .
      deploy:
        provider: pages
        strategy: git
        local_dir: site
        token: $GITHUB_TOKEN
        keep_history: true
        skip_cleanup: true
        on:
          branch: master
    - stage: release
      language: node_js
      node_js: lts/*
      services: docker
      install:
        - npm install semantic-release
                      @semantic-release/exec
                      @google/semantic-release-replace-plugin
                      conventional-changelog-conventionalcommits
      script: npx semantic-release

stages:
  - name: test
  - name: doc
  - name: release
    if: branch = master AND type = push

branches:
  except:
    - /^v\d+\.\d+\.\d+$/
